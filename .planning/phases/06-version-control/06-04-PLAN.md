---
phase: 06-version-control
plan: 04
type: execute
depends_on: ["06-01"]
files_modified: [src/version/diff.ts, src/version/types.ts, src/version/index.ts, src/cli/commands/version.ts]
---

<objective>
워크플로우 diff 보기 기능을 구현합니다.

Purpose: 워크플로우 변경 내용을 시각적으로 비교할 수 있는 diff 기능 제공
Output: 워크플로우 JSON diff 함수 및 CLI diff 명령어
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./06-04-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-version-control/06-01-SUMMARY.md

# 참조 파일:
@src/version/git.ts
@src/version/types.ts
@src/backup/types.ts

**기술 스택:**
- TypeScript 5.x, ES Modules
- simple-git (git diff, git show)

**결정 사항:**
- 워크플로우 JSON 구조 기반 의미 있는 diff 생성
- 노드 수준의 변경 요약: 추가/삭제/수정된 노드 목록
- 연결 변경 사항도 표시
- CLI 출력은 컬러 지원 (chalk 라이브러리 활용 고려)
</context>

<tasks>

<task type="auto">
  <name>Task 1: diff 타입 정의 및 모듈 구현</name>
  <files>src/version/types.ts, src/version/diff.ts</files>
  <action>
1. src/version/types.ts에 diff 관련 타입 추가:
   - NodeDiff: nodeId, nodeName, nodeType, changeType ('added' | 'removed' | 'modified'), details
   - ConnectionDiff: from, to, changeType
   - WorkflowDiff: workflowId, workflowName, nodes (NodeDiff[]), connections (ConnectionDiff[]), settingsChanged, summary

2. src/version/diff.ts 생성:
   - compareWorkflows(oldWorkflow, newWorkflow): 두 워크플로우 JSON 비교
     - 노드 비교: ID 기준 추가/삭제/수정 판별
     - 연결 비교: source-target 쌍 기준 비교
     - 설정 변경 여부 확인
     - WorkflowDiff 반환

   - getWorkflowAtCommit(repoPath, filePath, commitHash): 특정 커밋의 워크플로우 조회
     - git show 명령어로 과거 버전 읽기

   - formatDiff(diff): diff 결과를 사람이 읽기 쉬운 문자열로 변환
     - 노드 추가: "+ [노드타입] 노드이름"
     - 노드 삭제: "- [노드타입] 노드이름"
     - 노드 수정: "~ [노드타입] 노드이름: 변경 내용"
  </action>
  <verify>npm run build 성공</verify>
  <done>diff.ts 모듈에 워크플로우 비교 함수 구현 완료</done>
</task>

<task type="auto">
  <name>Task 2: version diff CLI 명령어 추가</name>
  <files>src/cli/commands/version.ts</files>
  <action>
src/cli/commands/version.ts에 diff 하위 명령어 추가:
- `n8n-wfm version diff <file>` - 워크플로우 변경 내용 비교
  - 인자 없이: working tree vs HEAD 비교
  - --commit <hash>: 특정 커밋과 비교
  - --commits <hash1> <hash2>: 두 커밋 간 비교
  - --summary: 요약만 표시 (노드 추가/삭제 개수)
  - --json: JSON 형식으로 출력

출력 형식:
- 변경된 노드 목록 (추가/삭제/수정)
- 연결 변경 사항
- 설정 변경 여부
  </action>
  <verify>
npm run build 성공
node dist/index.js version diff --help 출력 확인
  </verify>
  <done>version diff CLI 명령어 구현</done>
</task>

<task type="auto">
  <name>Task 3: version 모듈 인덱스 업데이트 및 빌드 검증</name>
  <files>src/version/index.ts</files>
  <action>
1. src/version/index.ts 수정:
   - diff.ts에서 함수 재내보내기:
     - compareWorkflows
     - getWorkflowAtCommit
     - formatDiff
   - 새 타입 재내보내기:
     - NodeDiff
     - ConnectionDiff
     - WorkflowDiff

2. 빌드 검증:
   - npm run build 실행
   - version 명령어 전체 기능 확인
  </action>
  <verify>
npm run build 성공
node dist/index.js version --help에서 모든 하위 명령어 표시 확인
  </verify>
  <done>version 모듈 완성, diff 기능 추가, Phase 6 완료</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` 성공
- [ ] `node dist/index.js version diff --help` 정상 출력
- [ ] compareWorkflows 함수로 두 워크플로우 비교 가능
- [ ] getWorkflowAtCommit으로 과거 버전 조회 가능
- [ ] Phase 6 Version Control 완료
</verification>

<success_criteria>
- 워크플로우 diff 기능 구현됨
- 노드/연결 수준의 변경 비교 가능
- version diff CLI 명령어 동작
- 빌드 성공
- Phase 6 전체 완료
</success_criteria>

<output>
완료 후 `.planning/phases/06-version-control/06-04-SUMMARY.md` 생성
</output>
