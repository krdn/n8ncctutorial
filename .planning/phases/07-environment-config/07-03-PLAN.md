---
phase: 07-environment-config
plan: 03
type: execute
depends_on: ["07-01"]
files_modified: [src/types/config.ts, src/config/credentials.ts, src/config/index.ts, config.example.yaml]
---

<objective>
credentials 환경별 매핑 기능을 구현하여 배포 시 credential 자동 변환을 지원합니다.

Purpose: 워크플로우 배포 시 환경별로 다른 credential ID를 자동 매핑
Output: credential 매핑 설정 구조 및 변환 유틸리티
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./07-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-environment-config/07-01-PLAN.md

# 참조 파일:
@src/types/config.ts
@src/config/index.ts
@src/workflow/types.ts

**기술 스택:**
- TypeScript 5.x, ES Modules
- n8n 워크플로우 JSON 구조 (credentials 필드)

**배경:**
- n8n 워크플로우에서 credential은 ID로 참조됨
- 환경(dev/staging/prod)마다 credential ID가 다름
- 배포 시 credential ID 변환 필요

**결정 사항:**
- 설정 파일에 credentialMappings 섹션 추가
- 논리적 이름 -> 환경별 실제 ID 매핑
- 배포 시 자동 변환 지원 (Phase 8에서 활용)
</context>

<tasks>

<task type="auto">
  <name>Task 1: credential 매핑 타입 정의</name>
  <files>src/types/config.ts</files>
  <action>
src/types/config.ts에 credential 매핑 타입 추가:

1. CredentialMapping 인터페이스:
   - name: string - 논리적 credential 이름 (예: "slack-bot")
   - type: string - credential 타입 (예: "slackApi")
   - environments: Record<string, string> - 환경별 실제 ID 매핑
     예: { dev: "1", staging: "5", prod: "12" }

2. Config 인터페이스 확장:
   - credentialMappings?: CredentialMapping[] 추가

3. CredentialTransform 타입:
   - sourceEnv: string
   - targetEnv: string
   - mappings: { originalId: string, newId: string }[]
  </action>
  <verify>npm run build 성공</verify>
  <done>credential 매핑 타입 정의</done>
</task>

<task type="auto">
  <name>Task 2: credential 변환 모듈 구현</name>
  <files>src/config/credentials.ts</files>
  <action>
src/config/credentials.ts 생성:

1. getCredentialMapping(config, name): CredentialMapping | null
   - 이름으로 credential 매핑 검색

2. getCredentialIdForEnv(config, mappingName, envName): string | null
   - 특정 환경의 credential ID 반환

3. buildCredentialTransform(config, sourceEnv, targetEnv): CredentialTransform
   - 두 환경 간 전체 credential 변환 맵 생성
   - Phase 8 배포 시 사용

4. listCredentialMappings(config): CredentialMappingSummary[]
   - 모든 매핑 요약 목록 반환
   - name, type, 환경별 ID 존재 여부

5. validateCredentialMappings(config): ValidationResult
   - 매핑 유효성 검증
   - 환경 이름이 실제 환경과 일치하는지 확인
  </action>
  <verify>npm run build 성공</verify>
  <done>credential 변환 모듈 구현</done>
</task>

<task type="auto">
  <name>Task 3: 설정 스키마 및 예제 파일 업데이트</name>
  <files>src/config/schema.ts, src/config/index.ts, config.example.yaml</files>
  <action>
1. src/config/schema.ts 수정:
   - credentialMappings 검증 로직 추가
   - 환경 이름 일치 검증

2. src/config/index.ts 수정:
   - credentials.ts에서 함수 재내보내기:
     - getCredentialMapping
     - getCredentialIdForEnv
     - buildCredentialTransform
     - listCredentialMappings
     - validateCredentialMappings
   - 새 타입 재내보내기

3. config.example.yaml 업데이트:
   - credentialMappings 섹션 예제 추가
   - 사용법 주석 포함

4. 빌드 검증
  </action>
  <verify>
npm run build 성공
설정 파일에 credentialMappings 추가 시 정상 로드
  </verify>
  <done>credential 매핑 설정 완료, Phase 7 완료</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` 성공
- [ ] CredentialMapping 타입 정의됨
- [ ] getCredentialIdForEnv 함수로 환경별 ID 조회 가능
- [ ] buildCredentialTransform으로 변환 맵 생성 가능
- [ ] config.example.yaml에 credentialMappings 예제 포함
- [ ] Phase 7 Environment Config 완료
</verification>

<success_criteria>
- credential 매핑 설정 구조 정의됨
- 환경별 credential ID 조회 유틸리티 동작
- 변환 맵 생성으로 Phase 8 배포 준비 완료
- 빌드 성공
- Phase 7 전체 완료
</success_criteria>

<output>
완료 후 `.planning/phases/07-environment-config/07-03-SUMMARY.md` 생성
</output>
