---
phase: 08-deployment-core
plan: 04
type: execute
depends_on: ["08-02", "08-03"]
files_modified: [src/deploy/verify.ts, src/deploy/rollback.ts, src/deploy/pipeline.ts, src/deploy/index.ts]
---

<objective>
배포 검증 및 롤백 기능을 구현합니다.

Purpose: 배포 후 워크플로우 정상 확인 및 문제 시 롤백 지원
Output: 검증 함수, 롤백 함수, 파이프라인 verify 단계 구현
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./08-04-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-deployment-core/08-01-PLAN.md
@.planning/phases/08-deployment-core/08-02-PLAN.md

# 참조 파일:
@src/deploy/types.ts
@src/deploy/pipeline.ts
@src/backup/backup.ts
@src/restore/restore.ts
@src/api/client.ts

**기술 스택:**
- TypeScript 5.x, ES Modules
- 기존 backup/restore 모듈 활용
- N8nApiClient.getWorkflow로 존재 확인

**배경:**
- 배포 후 대상 환경에 워크플로우가 정상 생성/업데이트 되었는지 확인 필요
- 문제 발생 시 롤백 가능해야 함
- 배포 전 자동 백업으로 롤백 데이터 확보

**결정 사항:**
- verifyDeployment: 배포된 워크플로우 존재 및 상태 확인
- 롤백은 배포 전 백업 기반
- 배포 이력 저장하여 롤백 대상 식별
</context>

<tasks>

<task type="auto">
  <name>Task 1: 배포 검증 모듈</name>
  <files>src/deploy/verify.ts</files>
  <action>
src/deploy/verify.ts 생성:

1. VerificationResult 인터페이스:
   - workflowId: string
   - workflowName: string
   - exists: boolean
   - active: boolean
   - nodeCount: number
   - error?: string

2. VerificationSummary 인터페이스:
   - total: number
   - verified: number
   - failed: number
   - results: VerificationResult[]

3. verifyWorkflow(
     client: N8nApiClient,
     workflowId: string
   ): Promise<VerificationResult>
   - API로 워크플로우 조회 시도
   - 존재 여부, 활성화 상태, 노드 수 확인
   - 조회 실패 시 exists: false 반환

4. verifyDeployment(
     client: N8nApiClient,
     deployedWorkflows: DeployedWorkflow[]
   ): Promise<VerificationSummary>
   - 배포된 모든 워크플로우 검증
   - targetId로 각각 verifyWorkflow 호출
   - 결과 집계

5. compareWorkflows(
     source: N8nWorkflowDetail,
     target: N8nWorkflowDetail
   ): { match: boolean; differences: string[] }
   - 노드 수, 이름, 연결 구조 비교
   - 차이점 목록 반환 (심층 검증용)
  </action>
  <verify>npm run build 성공</verify>
  <done>배포 검증 모듈</done>
</task>

<task type="auto">
  <name>Task 2: 롤백 모듈</name>
  <files>src/deploy/rollback.ts, src/deploy/types.ts</files>
  <action>
1. src/deploy/types.ts에 추가:
   - DeploymentRecord 인터페이스:
     - id: string (배포 ID, timestamp 기반)
     - timestamp: string
     - sourceEnv: string
     - targetEnv: string
     - workflows: { originalId: string; targetId: string; previousTargetId?: string }[]
     - backupPath?: string (배포 전 백업 경로)

2. src/deploy/rollback.ts 생성:
   - RollbackOptions 인터페이스:
     - deploymentId?: string (특정 배포 롤백)
     - workflowIds?: string[] (특정 워크플로우만 롤백)

   - RollbackResult 인터페이스:
     - success: boolean
     - restoredCount: number
     - errors: string[]

   - saveDeploymentRecord(
       record: DeploymentRecord,
       outputDir: string
     ): Promise<string>
     - 배포 기록을 JSON 파일로 저장
     - .n8n-wfm/deployments/{timestamp}.json

   - loadDeploymentRecord(
       deploymentId: string,
       baseDir: string
     ): Promise<DeploymentRecord | null>
     - 배포 기록 로드

   - listDeploymentRecords(baseDir: string): Promise<DeploymentRecord[]>
     - 모든 배포 기록 목록

   - rollbackDeployment(
       client: N8nApiClient,
       record: DeploymentRecord,
       options: RollbackOptions
     ): Promise<RollbackResult>
     - 백업 경로에서 워크플로우 복원
     - 기존 restore 모듈 활용
  </action>
  <verify>npm run build 성공</verify>
  <done>롤백 모듈</done>
</task>

<task type="auto">
  <name>Task 3: 파이프라인 verify 단계 및 백업 통합</name>
  <files>src/deploy/pipeline.ts, src/deploy/index.ts</files>
  <action>
1. src/deploy/pipeline.ts 수정:
   - verify 메서드 구현:
     - verifyDeployment 호출
     - 실패한 워크플로우 목록 DeploymentResult.errors에 추가

   - 백업 옵션 처리 (createBackup: true인 경우):
     - runPipeline 시작 시 대상 환경 백업 생성
     - 백업 경로를 DeploymentRecord에 저장

   - runPipeline 최종 흐름:
     1. validate
     2. backup (옵션)
     3. prepare
     4. for each: transform → deploy
     5. verify
     6. saveDeploymentRecord
     7. return DeploymentResult

2. src/deploy/index.ts 수정:
   - verify.ts 재내보내기:
     - verifyWorkflow
     - verifyDeployment
     - VerificationResult
     - VerificationSummary

   - rollback.ts 재내보내기:
     - rollbackDeployment
     - saveDeploymentRecord
     - loadDeploymentRecord
     - listDeploymentRecords
     - DeploymentRecord
     - RollbackResult
  </action>
  <verify>npm run build 성공</verify>
  <done>파이프라인 verify 및 백업 통합</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` 성공
- [ ] `verifyDeployment` 함수로 배포 결과 검증 가능
- [ ] `saveDeploymentRecord`로 배포 기록 저장 가능
- [ ] `rollbackDeployment` 함수로 이전 상태 복원 가능
- [ ] 배포 전 자동 백업 옵션 동작
</verification>

<success_criteria>
- 배포 후 검증으로 정상 배포 확인
- 배포 기록 저장으로 롤백 가능
- 자동 백업으로 안전한 배포 보장
</success_criteria>

<output>
완료 후 `.planning/phases/08-deployment-core/08-04-SUMMARY.md` 생성
</output>
