---
phase: 08-deployment-core
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [src/deploy/transfer.ts, src/deploy/pipeline.ts]
---

<objective>
환경 간 워크플로우 전송 기능을 구현합니다.

Purpose: 소스 환경에서 워크플로우를 가져와 대상 환경으로 전송
Output: 워크플로우 전송 함수, 파이프라인 deploy 단계 구현
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./08-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-deployment-core/08-01-PLAN.md

# 참조 파일:
@src/deploy/types.ts
@src/deploy/pipeline.ts
@src/workflow/export.ts
@src/workflow/import.ts
@src/api/client.ts

**기술 스택:**
- TypeScript 5.x, ES Modules
- N8nApiClient 기존 메서드 활용
- export/import 모듈 패턴 참조

**배경:**
- 워크플로우 전송 = API로 소스에서 조회 → 대상에 생성/업데이트
- 파일 시스템 미경유 (직접 API-to-API 전송)
- 기존 워크플로우 있으면 upsert 옵션에 따라 처리

**결정 사항:**
- transferWorkflow: 단일 워크플로우 전송
- transferWorkflows: 다중 워크플로우 전송
- 이름 기반 매칭으로 upsert 구현
</context>

<tasks>

<task type="auto">
  <name>Task 1: 워크플로우 전송 모듈</name>
  <files>src/deploy/transfer.ts</files>
  <action>
src/deploy/transfer.ts 생성:

1. TransferOptions 인터페이스:
   - mode: 'create' | 'update' | 'upsert' (기본: upsert)
   - activateAfterTransfer: boolean (기본: false)
   - preserveId: boolean (기본: false, ID 유지 시도)

2. TransferResult 인터페이스:
   - workflowId: string (원본 ID)
   - workflowName: string
   - targetId: string (대상 환경 ID)
   - action: 'created' | 'updated' | 'skipped'
   - success: boolean
   - error?: string

3. prepareWorkflowForTransfer(workflow: N8nWorkflowDetail): N8nWorkflowDetail
   - 불필요한 메타데이터 제거 (createdAt, updatedAt)
   - staticData, pinData 제거 옵션
   - ID 처리 (preserveId에 따라)

4. transferWorkflow(
     sourceClient: N8nApiClient,
     targetClient: N8nApiClient,
     workflowId: string,
     options: TransferOptions
   ): Promise<TransferResult>
   - 소스에서 워크플로우 조회
   - prepareWorkflowForTransfer 적용
   - 대상 환경에서 이름으로 기존 워크플로우 검색
   - mode에 따라 create/update/upsert 수행
   - 활성화 옵션 처리
   - 결과 반환

5. findWorkflowByNameInTarget(
     client: N8nApiClient,
     name: string
   ): Promise<N8nWorkflow | null>
   - 대상 환경에서 이름으로 워크플로우 검색
  </action>
  <verify>npm run build 성공</verify>
  <done>워크플로우 전송 모듈</done>
</task>

<task type="auto">
  <name>Task 2: 다중 워크플로우 전송</name>
  <files>src/deploy/transfer.ts</files>
  <action>
src/deploy/transfer.ts에 추가:

1. transferWorkflows(
     sourceClient: N8nApiClient,
     targetClient: N8nApiClient,
     workflowIds: string[],
     options: TransferOptions
   ): Promise<TransferResult[]>
   - 지정된 워크플로우들 순차 전송
   - 개별 에러는 결과에 포함하고 계속 진행
   - 전체 결과 배열 반환

2. transferAllWorkflows(
     sourceClient: N8nApiClient,
     targetClient: N8nApiClient,
     options: TransferOptions
   ): Promise<TransferResult[]>
   - 소스 환경의 모든 워크플로우 조회
   - transferWorkflows 호출

3. DEFAULT_TRANSFER_OPTIONS 상수:
   - mode: 'upsert'
   - activateAfterTransfer: false
   - preserveId: false
  </action>
  <verify>npm run build 성공</verify>
  <done>다중 워크플로우 전송</done>
</task>

<task type="auto">
  <name>Task 3: 파이프라인 deploy 단계 연동</name>
  <files>src/deploy/pipeline.ts, src/deploy/index.ts</files>
  <action>
1. src/deploy/pipeline.ts 수정:
   - deploy 메서드 구현:
     - transformedWorkflow와 options 받아 전송 실행
     - transferWorkflow 호출 (credential 변환된 워크플로우)
     - 결과를 DeployedWorkflow로 변환

   - runPipeline 구현 확장:
     - prepare 단계에서 워크플로우 목록 가져오기
     - 각 워크플로우에 대해 transform → deploy 실행
     - 결과 집계하여 DeploymentResult 반환

2. src/deploy/index.ts 수정:
   - transfer.ts에서 함수/타입 재내보내기:
     - transferWorkflow
     - transferWorkflows
     - transferAllWorkflows
     - TransferOptions
     - TransferResult
     - DEFAULT_TRANSFER_OPTIONS
  </action>
  <verify>npm run build 성공</verify>
  <done>파이프라인 deploy 단계 연동</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` 성공
- [ ] `transferWorkflow` 함수로 단일 워크플로우 전송 가능
- [ ] `transferWorkflows` 함수로 다중 워크플로우 전송 가능
- [ ] `transferAllWorkflows` 함수로 전체 워크플로우 전송 가능
- [ ] `DeploymentPipeline.deploy` 메서드 구현됨
</verification>

<success_criteria>
- 환경 간 워크플로우 API-to-API 전송 동작
- upsert 모드로 기존 워크플로우 업데이트 지원
- 파이프라인에 전송 기능 통합
</success_criteria>

<output>
완료 후 `.planning/phases/08-deployment-core/08-02-SUMMARY.md` 생성
</output>
