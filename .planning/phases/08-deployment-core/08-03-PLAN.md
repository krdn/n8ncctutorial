---
phase: 08-deployment-core
plan: 03
type: execute
depends_on: ["08-01"]
files_modified: [src/deploy/transform.ts, src/deploy/pipeline.ts, src/deploy/index.ts]
---

<objective>
워크플로우 내 credential ID를 환경에 맞게 변환하는 기능을 구현합니다.

Purpose: 배포 시 credential ID를 소스 환경 → 대상 환경으로 자동 변환
Output: credential 변환 함수, 파이프라인 transform 단계 구현
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./08-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-environment-config/07-03-SUMMARY.md
@.planning/phases/08-deployment-core/08-01-PLAN.md

# 참조 파일:
@src/config/credentials.ts
@src/types/n8n.ts (N8nNode.credentials 구조)
@src/deploy/types.ts

**기술 스택:**
- TypeScript 5.x, ES Modules
- buildCredentialTransform (Phase 7 구현물)
- N8nNode.credentials: Record<string, unknown>

**배경:**
- n8n 노드의 credentials 필드: { "slackApi": { "id": "1", "name": "Slack" } }
- 배포 시 id 값을 대상 환경의 credential ID로 변환 필요
- credentialMappings 설정 기반 변환

**결정 사항:**
- transformCredentialsInWorkflow: 워크플로우 내 모든 노드의 credential 변환
- 변환 맵에 없는 credential은 그대로 유지 (경고 로그)
- 변환된 credential 수 카운트하여 반환
</context>

<tasks>

<task type="auto">
  <name>Task 1: Credential 변환 유틸리티</name>
  <files>src/deploy/transform.ts</files>
  <action>
src/deploy/transform.ts 생성:

1. NodeCredentialInfo 타입:
   - id: string
   - name: string

2. TransformStats 인터페이스:
   - nodesProcessed: number
   - credentialsTransformed: number
   - credentialsUnmapped: string[] (변환 맵에 없는 credential ID 목록)

3. transformNodeCredentials(
     node: N8nNode,
     credentialTransform: CredentialTransform
   ): { node: N8nNode; transformed: number; unmapped: string[] }
   - 노드의 credentials 객체 순회
   - 각 credential의 id를 변환 맵에서 검색
   - 매핑 존재하면 새 ID로 교체
   - 매핑 없으면 원본 유지, unmapped에 추가
   - 변환된 노드와 통계 반환

4. extractCredentialId(credential: unknown): string | null
   - credentials 객체에서 id 추출
   - { id: "1", name: "Slack" } 형태 파싱
  </action>
  <verify>npm run build 성공</verify>
  <done>Credential 변환 유틸리티</done>
</task>

<task type="auto">
  <name>Task 2: 워크플로우 전체 변환</name>
  <files>src/deploy/transform.ts</files>
  <action>
src/deploy/transform.ts에 추가:

1. TransformResult 인터페이스:
   - workflow: N8nWorkflowDetail (변환된 워크플로우)
   - stats: TransformStats

2. transformCredentialsInWorkflow(
     workflow: N8nWorkflowDetail,
     credentialTransform: CredentialTransform
   ): TransformResult
   - workflow.nodes 순회
   - 각 노드에 transformNodeCredentials 적용
   - 변환된 노드들로 새 워크플로우 객체 생성
   - 전체 통계 집계하여 반환

3. createCredentialTransformFromConfig(
     config: Config,
     sourceEnv: string,
     targetEnv: string
   ): CredentialTransform
   - config.credentials의 buildCredentialTransform 호출
   - 편의 함수로 래핑
  </action>
  <verify>npm run build 성공</verify>
  <done>워크플로우 전체 변환</done>
</task>

<task type="auto">
  <name>Task 3: 파이프라인 transform 단계 통합</name>
  <files>src/deploy/pipeline.ts, src/deploy/index.ts</files>
  <action>
1. src/deploy/pipeline.ts 수정:
   - transformCredentials 메서드 구현:
     - transformCredentialsInWorkflow 호출
     - TransformStats를 DeployedWorkflow.credentialsTransformed에 반영
     - unmapped credentials 경고 로깅

   - prepare 메서드 확장:
     - buildCredentialTransform 호출하여 변환 맵 준비
     - PrepareResult에 credentialTransform 포함

   - runPipeline 흐름:
     1. validate
     2. prepare (워크플로우 목록 + 변환 맵)
     3. for each workflow: transform → deploy
     4. collect results → DeploymentResult

2. src/deploy/index.ts 수정:
   - transform.ts에서 재내보내기:
     - transformCredentialsInWorkflow
     - TransformResult
     - TransformStats
  </action>
  <verify>npm run build 성공</verify>
  <done>파이프라인 transform 단계 통합</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` 성공
- [ ] `transformCredentialsInWorkflow` 함수로 워크플로우 credential 변환 가능
- [ ] 변환 통계 (transformed, unmapped) 정상 반환
- [ ] `DeploymentPipeline.transformCredentials` 메서드 동작
- [ ] unmapped credentials 경고 메시지 출력
</verification>

<success_criteria>
- credential ID 자동 변환 동작
- 변환 맵에 없는 credential 식별 및 경고
- 파이프라인에 변환 단계 통합
</success_criteria>

<output>
완료 후 `.planning/phases/08-deployment-core/08-03-SUMMARY.md` 생성
</output>
