---
phase: 10-alerting
plan: 02
type: execute
depends_on: ["10-01"]
files_modified: [src/alert/detector.ts, src/alert/trigger.ts, src/cli/commands/alert.ts, src/cli/commands/index.ts]
---

<objective>
오류 감지 및 알림 트리거 구현 - 모니터링 데이터를 기반으로 오류 발생 시 알림 전송

Purpose: 워크플로우 실행 오류를 감지하고 설정된 채널로 알림을 자동 전송
Output: 오류 감지 함수, 알림 트리거 함수, CLI alert 명령어 (수동 테스트용)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-alerting/10-01-SUMMARY.md

**기존 모듈 참조:**
@src/monitor/executions.ts
@src/monitor/types.ts
@src/alert/types.ts
@src/alert/send.ts

**Tech stack available:**
- 모니터링 모듈 (fetchMonitoringData, getExecutions)
- 알림 모듈 (sendAlert, sendAlerts)

**Established patterns:**
- 모니터링 필터를 통한 실행 조회
- Commander.js CLI 명령어 패턴
</context>

<tasks>

<task type="auto">
  <name>Task 1: 오류 감지 함수 구현</name>
  <files>src/alert/detector.ts</files>
  <action>
1. src/alert/detector.ts 생성:
   - DetectionResult 인터페이스: { hasErrors: boolean, executions: N8nExecution[], detectedAt: Date }

   - detectErrors(client: N8nApiClient, options?: DetectionOptions): Promise<DetectionResult>
     - options: { since?: Date, workflowIds?: string[], limit?: number }
     - 기본 since: 1시간 이내
     - status: 'error'인 실행만 필터링
     - getExecutions 함수 활용

   - detectNewErrors(client: N8nApiClient, lastChecked: Date): Promise<DetectionResult>
     - lastChecked 이후 발생한 에러만 감지
     - 중복 알림 방지를 위한 시점 기반 필터

   - getErrorDetails(execution: N8nExecution): ErrorDetails
     - ErrorDetails: { workflowId, workflowName?, executionId, errorMessage?, startedAt, stoppedAt? }
     - 실행 객체에서 에러 정보 추출
  </action>
  <verify>npm run build 성공</verify>
  <done>detectErrors(), detectNewErrors() 함수로 오류 감지 가능</done>
</task>

<task type="auto">
  <name>Task 2: 알림 트리거 함수 구현</name>
  <files>src/alert/trigger.ts, src/alert/index.ts</files>
  <action>
1. src/alert/trigger.ts 생성:
   - TriggerResult 인터페이스: { triggered: boolean, alertsSent: number, results: AlertResult[] }

   - triggerAlertForExecution(
       execution: N8nExecution,
       channels: AlertChannelConfig[],
       severity?: AlertSeverity
     ): Promise<TriggerResult>
     - 단일 실행에 대한 알림 생성 및 전송
     - AlertMessage 생성: title="워크플로우 실행 오류", message=에러 상세

   - triggerAlertsForErrors(
       detectionResult: DetectionResult,
       channels: AlertChannelConfig[],
       options?: { maxAlerts?: number }
     ): Promise<TriggerResult>
     - 감지된 오류들에 대해 알림 전송
     - maxAlerts로 한 번에 전송할 최대 알림 수 제한 (기본 10)
     - 개별 실행마다 알림 또는 요약 알림 선택 가능

   - createErrorAlertMessage(execution: N8nExecution): AlertMessage
     - 실행 정보를 AlertMessage로 변환

2. src/alert/index.ts 수정:
   - detector.ts, trigger.ts export 추가
  </action>
  <verify>npm run build 성공</verify>
  <done>triggerAlertForExecution(), triggerAlertsForErrors() 함수로 자동 알림 트리거 가능</done>
</task>

<task type="auto">
  <name>Task 3: CLI alert 명령어 구현</name>
  <files>src/cli/commands/alert.ts, src/cli/commands/index.ts</files>
  <action>
1. src/cli/commands/alert.ts 생성:
   - registerAlertCommand(program: Command): void

   - alert test 서브커맨드:
     - 테스트 알림 전송 (설정된 모든 채널에)
     - -c, --config: 설정 파일 경로
     - -m, --message: 테스트 메시지 (기본: "Test alert from n8n-wfm")
     - --severity: 알림 심각도 (기본: info)

   - alert check 서브커맨드:
     - 현재 오류 상태 확인 및 알림 전송
     - -c, --config: 설정 파일 경로
     - -e, --env: 환경 지정
     - --since: 확인 시작 시점 (기본: 1시간 전)
     - --dry-run: 알림 전송 없이 감지된 오류만 출력

   - alert status 서브커맨드:
     - 알림 설정 상태 표시
     - -c, --config: 설정 파일 경로
     - 설정된 채널 목록, 활성화 상태 출력

2. src/cli/commands/index.ts 수정:
   - registerAlertCommand import 및 등록
  </action>
  <verify>npm run build 성공, n8n-wfm alert --help 출력 확인</verify>
  <done>alert test, alert check, alert status 명령어 동작</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] src/alert/detector.ts 존재
- [ ] src/alert/trigger.ts 존재
- [ ] `n8n-wfm alert --help` 정상 출력
- [ ] `n8n-wfm alert test --help` 정상 출력
- [ ] `n8n-wfm alert check --help` 정상 출력
</verification>

<success_criteria>
- 오류 감지 함수 (detectErrors, detectNewErrors) 구현
- 알림 트리거 함수 (triggerAlertForExecution, triggerAlertsForErrors) 구현
- CLI alert 명령어 (test, check, status) 구현
- 모든 함수가 alert 모듈에서 export됨
</success_criteria>

<output>
After completion, create `.planning/phases/10-alerting/10-02-SUMMARY.md`
</output>
