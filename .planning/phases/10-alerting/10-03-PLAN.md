---
phase: 10-alerting
plan: 03
type: execute
depends_on: ["10-02"]
files_modified: [src/alert/rules.ts, src/alert/types.ts, src/alert/watcher.ts, src/cli/commands/alert.ts, src/alert/index.ts]
---

<objective>
알림 규칙 관리 - 규칙 기반 자동 알림 및 CLI 관리 명령어 구현

Purpose: 사용자가 알림 규칙을 정의하고 규칙에 따라 자동으로 알림이 발생하도록 함
Output: 알림 규칙 타입, 규칙 저장/로드, 규칙 기반 알림, CLI 규칙 관리 명령어
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-alerting/10-01-SUMMARY.md
@.planning/phases/10-alerting/10-02-SUMMARY.md

**기존 모듈 참조:**
@src/alert/types.ts
@src/alert/detector.ts
@src/alert/trigger.ts
@src/cli/commands/alert.ts

**Tech stack available:**
- 알림 모듈 (sendAlert, detectErrors, triggerAlertsForErrors)
- YAML 설정 파일 패턴

**Established patterns:**
- Config 기반 설정 관리
- Commander.js CLI 명령어 패턴
</context>

<tasks>

<task type="auto">
  <name>Task 1: 알림 규칙 타입 및 저장 구현</name>
  <files>src/alert/types.ts, src/alert/rules.ts</files>
  <action>
1. src/alert/types.ts 수정 (타입 추가):
   - AlertRuleCondition: { type: 'error' | 'success_rate' | 'duration', threshold?: number, operator?: 'lt' | 'gt' | 'eq' }
   - AlertRule: { id: string, name: string, enabled: boolean, condition: AlertRuleCondition, workflowIds?: string[], channels: string[], severity: AlertSeverity, cooldown?: number }
   - AlertRulesConfig: { rules: AlertRule[] }

2. src/alert/rules.ts 생성:
   - loadRules(rulesPath: string): Promise<AlertRule[]>
     - YAML 파일에서 규칙 로드
     - 기본 경로: .n8n-wfm/alert-rules.yaml

   - saveRules(rulesPath: string, rules: AlertRule[]): Promise<void>
     - 규칙을 YAML 파일로 저장

   - evaluateRule(rule: AlertRule, context: RuleContext): boolean
     - RuleContext: { execution?: N8nExecution, stats?: WorkflowExecutionStats }
     - 규칙 조건 평가 (error=실행 에러 발생, success_rate=성공률 임계값, duration=실행 시간 임계값)

   - findMatchingRules(rules: AlertRule[], context: RuleContext): AlertRule[]
     - 컨텍스트에 매칭되는 활성화된 규칙들 반환
  </action>
  <verify>npm run build 성공</verify>
  <done>AlertRule 타입 정의됨, 규칙 로드/저장/평가 함수 구현됨</done>
</task>

<task type="auto">
  <name>Task 2: 규칙 기반 알림 watcher 구현</name>
  <files>src/alert/watcher.ts, src/alert/index.ts</files>
  <action>
1. src/alert/watcher.ts 생성:
   - WatcherState: { lastChecked: Date, alertHistory: Map<string, Date> }

   - createWatcher(client: N8nApiClient, config: AlertConfig, rules: AlertRule[]): AlertWatcher
     - AlertWatcher 객체 반환

   - AlertWatcher 클래스 또는 객체:
     - checkOnce(): Promise<WatchResult>
       - 한 번 체크하고 규칙에 맞는 알림 전송
       - cooldown 시간 내 중복 알림 방지
     - getState(): WatcherState
       - 현재 상태 반환

   - WatchResult: { checked: number, matched: number, sent: number, errors: string[] }

2. src/alert/index.ts 수정:
   - rules.ts, watcher.ts export 추가
  </action>
  <verify>npm run build 성공</verify>
  <done>createWatcher()로 규칙 기반 알림 watcher 생성 가능</done>
</task>

<task type="auto">
  <name>Task 3: CLI 알림 규칙 관리 명령어</name>
  <files>src/cli/commands/alert.ts</files>
  <action>
1. src/cli/commands/alert.ts에 서브커맨드 추가:

   - alert rules 서브커맨드:
     - 설정된 알림 규칙 목록 표시
     - -c, --config: 설정 파일 경로
     - 출력: 규칙 ID, 이름, 조건, 활성화 상태, 연결된 채널

   - alert watch 서브커맨드:
     - 한 번 체크하고 규칙 기반 알림 전송
     - -c, --config: 설정 파일 경로
     - -e, --env: 환경 지정
     - --rules-file: 규칙 파일 경로 (기본: .n8n-wfm/alert-rules.yaml)
     - --dry-run: 알림 전송 없이 매칭 결과만 출력

   - alert init 서브커맨드 (선택):
     - 기본 알림 규칙 파일 생성
     - 예제 규칙 포함 (error 발생 시 알림)

2. 헬퍼 함수:
   - formatRuleCondition(condition: AlertRuleCondition): string
   - printRulesList(rules: AlertRule[]): void
  </action>
  <verify>npm run build 성공, n8n-wfm alert rules --help 출력 확인, n8n-wfm alert watch --help 출력 확인</verify>
  <done>alert rules, alert watch 명령어 동작, Phase 10 Alerting 완료</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] src/alert/rules.ts 존재
- [ ] src/alert/watcher.ts 존재
- [ ] `n8n-wfm alert rules --help` 정상 출력
- [ ] `n8n-wfm alert watch --help` 정상 출력
- [ ] TypeScript 에러 없음
</verification>

<success_criteria>
- AlertRule 타입 정의됨
- 규칙 로드/저장/평가 함수 구현됨
- Watcher로 규칙 기반 자동 알림 가능
- CLI alert rules, alert watch 명령어 동작
- Phase 10: Alerting 완료
</success_criteria>

<output>
After completion, create `.planning/phases/10-alerting/10-03-SUMMARY.md`:

# Phase 10-03: 알림 규칙 관리 Summary

**[요약 내용]**

## Accomplishments

- 알림 규칙 타입 및 저장/로드 구현
- 규칙 기반 알림 watcher 구현
- CLI alert rules, alert watch 명령어 추가

## Files Created/Modified

- src/alert/types.ts - AlertRule 타입 추가
- src/alert/rules.ts - 규칙 관리 함수
- src/alert/watcher.ts - 규칙 기반 watcher
- src/cli/commands/alert.ts - rules, watch 서브커맨드

## Decisions Made

[결정 사항]

## Issues Encountered

[발생한 이슈]

## Next Phase Readiness

Phase 10: Alerting 완료. 전체 프로젝트 완료.
</output>
